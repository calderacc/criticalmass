{% extends 'CalderaCriticalmassDesktopBundle:Common:StandardTemplate.html.twig' %}

{% block title %}Städte-Übersicht{% endblock %}
{% block content %}
    <script>
        function sortCityList(sortFunction)
        {
            var tableHeaderRow = $('#tableHeaderRow').html();
            $('#tableHeaderRow').remove();

            $('#cityList tr').sort(sortFunction).map(function () {
                return $(this).closest('#cityList tr');
            }).each(function (_, container) {
                $(container).parent().append(container);
            });

            $('#cityList').prepend('<tr id="tableHeaderRow">' + tableHeaderRow + '</tr>');
        }

        window.onload = function() {
            $('#sortByCity').on('click', function()
            {
                var sortFunction = function(a, b)
                {
                    return ($(a).data('cityname') > $(b).data('cityname') ? 1 : -1);
                };

                sortCityList(sortFunction);
            });

            $('#sortByDistance').on('click', function()
            {
                function successCallback(geolocationResult)
                {
                    var latitude = geolocationResult.coords.latitude;
                    var longitude = geolocationResult.coords.longitude;

                    var sortFunction = function(a, b)
                    {
                        var distanceA = Math.sqrt(Math.pow(latitude - $(a).data('latitude'), 2) + Math.pow(longitude - $(a).data('longitude'), 2));
                        var distanceB = Math.sqrt(Math.pow(latitude - $(b).data('latitude'), 2) + Math.pow(longitude - $(b).data('longitude'), 2));

                        return distanceA - distanceB;
                    };

                    sortCityList(sortFunction);
                }

                navigator.geolocation.getCurrentPosition(successCallback);
            });


            $('#sortByNextRide').on('click', function()
            {
                var sortFunction = function(a, b)
                {
                    return ($(a).data('currentride') > $(b).data('currentride') ? 1 : -1);
                };

                sortCityList(sortFunction);
            });
        }
    </script>
    <div class="container">
        <ol class="breadcrumb">
            <li><a href="#">criticalmass.in</a></li>
            <li class="active">Städteliste</li>
        </ol>

        <h1>Die nächste Masse ist ganz nah.</h1>
        <p class="lead">Die Critical-Mass-Bewegung ist in beinahe jeder größeren Stadt zu Hause.</p>

        <p>Auf den Sattel, fertig, los: Die folgende Liste enthält mittlerweile {{ cities|length }} Städte. Bitte bedenke, dass die folgenden Informationen aus verschiedenen Quellen im Internet stammen und womöglich veraltet oder schlichtweg falsch sein können. Überprüfe bitte vorher die einschlägigen Quellen wie facebook oder twitter, bevor du dich auf den Weg machst.</p>

        <div class="dropdown pull-right">
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
                Sortierung
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                <li id="sortByCity" role="presentation"><a role="menuitem" tabindex="-1" href="#">Stadt</a></li>
                <li id="sortByDistance" role="presentation"><a role="menuitem" tabindex="-1" href="#">Entfernung</a></li>
                <li id="sortByNextRide" role="presentation"><a role="menuitem" tabindex="-1" href="#">nächster Tour</a></li>
            </ul>
        </div>

        {#
        <div id="cityList">
            {% for city in cities %}
                <div class="col-md-4 city" data-cityName="{{ city.getCity() }}" data-cityslug="{{ city.getMainSlugString() }}" data-latitude="{{ city.getLatitude() }}" data-longitude="{{ city.getLongitude() }}">
                    <a href="{{ path('caldera_criticalmass_desktop_city_show', {'citySlug': city.getMainSlugString() }) }}"><h2>{{ city.getCity() }}</h2></a>
                    <p>{{ city.getDescription() }}</p>
                    <p><small>{{ city.getEventDateTimeString() }}</small></p>
                </div>
            {% endfor %}
        </div>
        #}
        <table id="cityList" class="table">
            <tr id="tableHeaderRow">
                <th>Stadt</th>
                <th>aktuelle Tour</th>
                <th>Turnus</th>
                <th>Touren</th>
            </tr>
            {% for city in cities %}
            <tr class="city" data-cityName="{{ city.getCity() }}" data-cityslug="{{ city.getMainSlugString() }}" data-latitude="{{ city.getLatitude() }}" data-longitude="{{ city.getLongitude() }}" data-currentRide="{% if city.getCurrentRide() %}{{ city.getCurrentRide().getDateTime().format('Y-m-d') }}{% else %}9999-99-99{% endif %}">
                <td><a href="{{ path('caldera_criticalmass_desktop_city_show', {'citySlug': city.getMainSlugString() }) }}">{{ city.getCity() }}</a></td>
                <td>{% if city.getCurrentRide() %}
                        <a href="{{ path('caldera_criticalmass_desktop_ride_show', { 'citySlug': city.getMainSlugString(), 'rideDate': city.getCurrentRide().getDateTime().format('Y-m-d') } ) }}">{{ city.getCurrentRide().getDateTime().format('l, d. M, H:i') }} Uhr</a>
                {% endif %}</td>
                <td>{{ city.getEventDateTimeString() }}</td>
                <td>{{ city.countRides() }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
{% endblock %}