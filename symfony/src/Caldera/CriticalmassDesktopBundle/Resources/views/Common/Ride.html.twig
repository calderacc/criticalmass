{% if dateTime > ride.getDateTime() %}
    {% set pastRide = true %}
{% else %}
    {% set pastRide = false %}
{% endif %}

{% set hasSocialMedia = ride.getUrl() or ride.getFacebook() or ride.getTwitter() %}

<div class="row">
    <div class="col-md-12">
        <h1>{{ ride.getFancyTitle() }}</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div id="map" style="height: 350px;"></div>
    </div>
</div>

{% javascripts
'@CalderaCriticalmassCoreBundle/Resources/public/js/external/*'
%}
<script type="text/javascript" src="{{ asset_url }}"></script>
{% endjavascripts %}
<script>
    var map = L.map('map');
    var tileLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        detectRetina: true
    });

    tileLayer.addTo(map);

    var markerGroup = L.featureGroup();
    var trackGroup = L.featureGroup();

    var popupContent = '<dl class="dl-horizontal">';
    popupContent += '<dt>Datum:</dt><dd>{{ ride.getDateTime.format('d.m.Y') }}</dd>';
    popupContent += '<dt>Uhrzeit:</dt><dd>{{ ride.getDateTime.format('H:i') }}</dd>';

    {% if ride.getWeatherForecast() %}
    popupContent += '<dt>Wetter:</dt><dd>{{ ride.getWeatherForecast() }}</dd>';
    {% endif %}

    {% if ride.hasLocation() %}
    popupContent += '<dt>Treffpunkt:</dt><dd>{{ ride.getLocation() }}</dd>';

    var mapCenter = L.latLng({{ ride.getLatitude() }}, {{ ride.getLongitude() }});

    var locationIcon = L.icon({
        iconUrl: '/images/marker/marker-red.png',
        iconRetinaUrl: '/images/marker/marker-red-2x.png',
        iconSize: [25, 41],
        iconAnchor: [13, 41],
        popupAnchor: [0, -36],
        shadowUrl: '/images/marker/defaultshadow.png',
        shadowSize: [41, 41],
        shadowAnchor: [13, 41]
    });

    var locationMarker = L.marker(mapCenter, { icon: locationIcon });
    {% else %}
    popupContent += '<dt>Treffpunkt:</td><dd>Der Treffpunkt ist leider noch nicht bekannt</dd>';

    var mapCenter = L.latLng({{ city.getLatitude() }}, {{ city.getLongitude() }});

    var cityIcon = L.icon({
        iconUrl: '/images/marker/marker-gray.png',
        iconRetinaUrl: '/images/marker/marker-gray-2x.png',
        iconSize: [25, 41],
        iconAnchor: [13, 41],
        popupAnchor: [0, -36],
        shadowUrl: '/images/marker/defaultshadow.png',
        shadowSize: [41, 41],
        shadowAnchor: [13, 41]
    });

    var locationMarker = L.marker(mapCenter, { icon: cityIcon });
    {% endif %}

    popupContent += '</dl>';

    locationMarker.addTo(markerGroup);
    locationMarker.bindPopup(popupContent);

    var subRideIcon = L.icon({
        iconUrl: '/images/marker/marker-blue.png',
        iconRetinaUrl: '/images/marker/marker-blue-2x.png',
        iconSize: [25, 41],
        iconAnchor: [13, 41],
        popupAnchor: [0, -36],
        shadowUrl: '/images/marker/defaultshadow.png',
        shadowSize: [41, 41],
        shadowAnchor: [13, 41]
    });

    var subRideMarkers = new Array();

    {% for subRide in ride.getActiveSubRides() %}
    var subRideMarker = L.marker([{{ subRide.getLatitude() }}, {{ subRide.getLongitude() }}], { icon: subRideIcon });
    subRideMarker.addTo(map);
    subRideMarker.bindPopup('<h5>{% if subRide.getTitle() %}{{ subRide.getTitle() }}{% else %}Mini-Mass{% endif %}</h5><dl class="dl-horizontal"><dt>Uhrzeit:</dt><dd>{{ subRide.getDateTime().format('H:i') }}</dd><dt>Treffpunkt:</dt> <dd>{{ subRide.getLocation() }}</dd></dl>{% if subRide.getDescription() %}<p>{{ subRide.getDescription()|nl2br|replace({"<br />":"\\"}) }}</p>{% endif %}');
    subRideMarkers[{{ subRide.getId() }}] = subRideMarker;
    markerGroup.addLayer(subRideMarker);
    {% endfor %}

    markerGroup.addTo(map);

    {% for track in ride.getActiveTracks() %}
    var trackLine = L.polyline({{ track.getPreviewJsonArray() }}, { color: 'rgb({{ track.getUser().getColorRed() }}, {{ track.getUser().getColorGreen() }}, {{ track.getUser().getColorBlue() }})' }).addTo(map);
    trackGroup.addLayer(trackLine);
    {% endfor %}

    trackGroup.addTo(map);

    {% if pastRide and ride.getActiveTracks()|length > 0 %}
    map.fitBounds(trackGroup.getBounds());
    {% else %}
    map.fitBounds(markerGroup.getBounds());
    locationMarker.openPopup();
    {% endif %}
</script>

<div class="row" style="margin-top: 1em;">
    <div class="col-md-12">
        <div role="tabpanel">
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#details" aria-controls="home" role="tab" data-toggle="tab">Details</a></li>
                <li role="presentation"><a href="#minimass" aria-controls="settings" role="tab" data-toggle="tab">Mini-Masses</a></li>
                <li role="presentation"><a href="#stats" aria-controls="profile" role="tab" data-toggle="tab">Statistik</a></li>
                <li role="presentation"><a href="#comments" aria-controls="messages" role="tab" data-toggle="tab">Kommentare</a></li>
                <li role="presentation"><a href="#gallery" aria-controls="settings" role="tab" data-toggle="tab">Galerie</a></li>
            </ul>
        
            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="details">
                    <div class="row">
                        <div class="col-md-8">
                            {% if app.getUser() %}
                                <div class="btn-group btn-group-xs pull-right" style="margin-top: 24px;">
                                    <a class="btn btn-default" href="{{ path('caldera_criticalmass_desktop_ride_edit', { citySlug: city.getMainSlugString(), rideDate: ride.getDateTime().format('Y-m-d') } ) }}" title="Tour bearbeiten"><i class="halflings uni-wrench"></i></a>
                                </div>
                            {% endif %}
                            
                            <h3>{{ ride.getFancyTitle() }}</h3>
                            
                            {% if ride.getDescription() %}
                            {{ ride.getDescription()|nl2br }}
                            {% endif %}
                        </div>
        
                        <div class="col-md-4">
                            {% if hasSocialMedia %}
                                <h4>Mehr im Netz</h4>
                                {% if ride.getUrl() %}
                                    <a class="btn btn-default" href="{{ ride.getUrl() }}"><i class="social rss"></i> Homepage</a>
                                {% endif %}
        
                                {% if ride.getFacebook() %}
                                    <a class="btn btn-default" href="{{ ride.getFacebook() }}"><i class="social facebook"></i> facebook</a>
                                {% endif %}
        
                                {% if ride.getTwitter() %}
                                    <a class="btn btn-default" href="{{ ride.getTwitter() }}"><i class="social twitter"></i> twitter</a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    
                    
                </div>
                
                <div role="tabpanel" class="tab-pane" id="minimass">
                    <div class="row">
                        <div class="col-md-12">
                            {% if app.getUser() %}
                            <div class="btn-group btn-group-xs pull-right" style="margin-top: 24px;">
                                <a class="btn btn-default" href="{{ path('caldera_criticalmass_desktop_subride_add', { citySlug: city.getMainSlugString(), rideDate: ride.getDateTime().format('Y-m-d') } ) }}" title="Mini-Mass anlegen"><i class="halflings map-marker"></i></a>
                            </div>
                            {% endif %}
                            <h3>Mini-Masses zu dieser Tour</h3>
                        </div>
                    </div>
                    
                    {% if ride.getActiveSubRides() %}
                        {% for subRide in ride.getActiveSubRides() %}
                        <div class="media subride">
                            {% if app.getUser() %}<a href="{{ path('caldera_criticalmass_desktop_subride_edit', { subRideId: subRide.getId() } ) }}" class="edit-subride pull-right btn btn-default btn-xs"><i class="halflings uni-wrench"></i></a>{% endif %}
                            <a class="pull-left subride" href="#" data-subrideid="{{ subRide.getId() }}">
                                <img class="media-object" src="/images/marker/marker-blue.png" alt="...">
                            </a>
                            <div class="media-body">
                                <h5 class="media-heading">{{ subRide.getDateTime().format('H.i') }} Uhr: {{ subRide.getTitle() }}</h5>
                                <p>{{ subRide.getDescription()|nl2br }}</p>
                            </div>
                        </div>
                        {% endfor %}
                        <script>
                            window.onload = function() {
                                $('.subride').on('click', function () {
                                    var subRideId = $(this).data('subrideid');
                                    var marker = subRideMarkers[subRideId];
        
                                    map.panTo(marker.getLatLng());
                                    marker.openPopup();
                                });
                            }
                        </script>
                    {% endif %}
                </div>
                
                <div role="tabpanel" class="tab-pane" id="stats">
                    <div class="row">
                        <div class="col-md-12">
                        {% if pastRide %}
                            <div class="btn-group btn-group-xs pull-right" style="margin-top: 24px;">
                                <a class="btn btn-default" href="#" data-toggle="modal" data-target="#modalEstimate" title="Tour schätzen"><i class="halflings signal"></i></a>
                                <a class="btn btn-default" href="#" data-toggle="modal" data-target="#modalTrackUpload" title="Track hochladen"><i class="halflings cloud_upload"></i></a>
                            </div>
                        {% endif %}
        
                            <h3>Statistik</h3>
                        </div>
                    </div>
                    
                    <table class="table">
                        <tr>
                            <th>Treffpunkt</th>
                            <td>{{ ride.getLocation() }}</td>
                            <td></td>
                        </tr>
                        <tr>
                            <th>Datum</th>
                            <td>{{ ride.getDateTime.format('d.m.Y H:i') }} Uhr</td>
                            <td></td>
                        </tr>
                        <tr>
                            <th>Teilnehmer</th>
                            <td>{{ ride.getEstimatedParticipants()|round }}</td>
                            <td><a href="#" data-toggle="modal" data-target="#modalEstimate" title="Tour schätzen">Werte schätzen?</a></td>
                        </tr>
                        <tr>
                            <th>Kilometer</th>
                            <td>{{ ride.getEstimatedDistance()|round(2) }}</td>
                            <td><a href="#" data-toggle="modal" data-target="#modalEstimate" title="Tour schätzen">Werte schätzen?</a></td>
                        </tr>
                        <tr>
                            <th>Stunden</th>
                            <td>{{ ride.getEstimatedDuration()|round(2) }}</td>
                            <td><a href="#" data-toggle="modal" data-target="#modalEstimate" title="Tour schätzen">Werte schätzen?</a></td>
                        </tr>
                    </table>
                </div>
                
                <div role="tabpanel" class="tab-pane" id="comments">
                    <div class="row">
                        <div class="col-md-12">
                            <h3>Kommentare zu dieser Tour</h3>
                            {{ render(controller('CalderaCriticalmassTimelineBundle:Post:list', { 'rideId': ride.getId() })) }}
        
                            {% if app.getUser() %}
                            {{ render(controller('CalderaCriticalmassTimelineBundle:Post:write', { 'rideId': ride.getId() })) }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane" id="gallery">...</div>
            </div>
        </div>
    </div>
</div>

{% if app.getUser() %}

{% if pastRide %}
<div class="modal fade" id="modalEstimate" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Tour schätzen</h4>
            </div>
            <div class="modal-body">
                {{ render(controller('CalderaCriticalmassStatisticBundle:Ride:estimateform', { 'rideId': ride.getId() })) }}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalTrackUpload" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Track zu dieser Tour hochladen</h4>
            </div>
            <div class="modal-body">
                {{ render(controller('CalderaCriticalmassTrackBundle:Track:upload')) }}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}